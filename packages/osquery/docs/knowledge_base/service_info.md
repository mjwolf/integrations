# Service Info

## Common use cases
Osquery is an open-source instrumentation framework that allows users to query their operating systems as if they were a high-performance relational database. This integration enables the collection of system metadata, security events, and compliance data by forwarding logs from the osquery daemon to the Elastic Stack.
- **Security Auditing and Monitoring:** Monitor file integrity, authorized processes, and socket connections across your entire fleet to detect malicious activity in real-time.
- **Compliance Management:** Regularly query system configurations, patch levels, and user accounts to ensure all endpoints meet organizational and regulatory security standards.
- **Threat Hunting:** Use scheduled queries to search for Indicators of Compromise (IOCs), such as specific persistent artifacts, unexpected kernel modules, or unauthorized SSH keys.
- **Incident Response:** Gather detailed forensic data from endpoints during an investigation, including running processes, open network connections, and recently modified system files.

## Data types collected

This integration can collect the following types of data:
- **Result Logs:** These are JSON-formatted logs containing the differential or snapshot results of scheduled SQL queries defined in the osquery configuration.
- **Status Logs:** These include internal operational logs generated by the osquery daemon (osqueryd), categorized into levels such as INFO, WARNING, and ERROR.
- **Data Formats:** Logs are typically captured in structured JSON format or standard Syslog format depending on the selected logger plugin.
- **Log File Paths:** 
    - Linux/macOS: `/var/log/osquery/osqueryd.results.log`, `/var/log/osquery/osqueryd.INFO`, `/var/log/osquery/osqueryd.WARNING`.
    - Windows: `C:\Program Files\osquery\log\osqueryd.results.log`, `C:\Program Files\osquery\log\osqueryd.INFO`.

## Compatibility

This integration is compatible with **osquery** version 5.x and higher. It supports major operating systems including **Linux (Ubuntu, CentOS, Debian, RHEL)**, **macOS (Intel and Apple Silicon)**, and **Windows (Server and Desktop versions)**.

## Scaling and Performance
- **Transport/Collection Considerations:** This integration utilizes Syslog for data transport. While UDP offers lower overhead, TCP (using the `@@` prefix in rsyslog) is strongly recommended to ensure reliable delivery of security-critical audit logs and to prevent data loss during network congestion.
- **Data Volume Management:** To manage log volume, users should optimize osquery schedules by using differential queries to only send changes. Additionally, the `rsyslog` daemon can be configured to filter out low-priority status logs (e.g., INFO level) before they are transmitted to the Elastic Agent, reducing unnecessary ingestion.
- **Elastic Agent Scaling:** A single Elastic Agent can handle thousands of events per second from multiple osquery hosts. For high-volume environments with tens of thousands of endpoints, it is recommended to deploy multiple Elastic Agents behind a load balancer to distribute the ingestion load and provide high availability.

# Set Up Instructions

## Vendor prerequisites
- **Administrative Access:** Sudo or root permissions are required on the host system to modify osquery and syslog configuration files.
- **Service Installation:** The `osqueryd` daemon must be installed and configured to run as a service on the target host.
- **Syslog Daemon:** A local syslog service (e.g., `rsyslog` or `syslog-ng`) must be active to facilitate the forwarding of logs to the Elastic Agent.
- **Network Connectivity:** The host must be able to reach the Elastic Agent's IP address on the specified syslog port (e.g., UDP/514 or TCP/9514).
- **Firewall Rules:** Ensure that any host-based or network firewalls allow outgoing traffic to the Elastic Agent on the chosen transport port.

## Elastic prerequisites

- **Elastic Agent:** An Elastic Agent must be installed on the host (or a remote collector) and enrolled in Fleet.
- **Fleet Management:** Access to Kibana with permissions to add and configure integration policies.
- **Network Connectivity:** If using remote syslog, ensure firewalls allow traffic on the designated port (e.g., UDP/TCP 514) between the osquery host and the Elastic Agent.

## Vendor set up steps

### For Linux and macOS (Syslog Collection):

1.  Open the osquery configuration file located at `/etc/osquery/osquery.conf` using a text editor with elevated permissions.
2.  Locate the `options` section in the JSON configuration and set the `logger_plugin` to `syslog`.
    ```json
    "options": {
      "logger_plugin": "syslog"
    }
    ```
3.  Define your query schedule in the `schedule` block to ensure data is generated (e.g., `SELECT * FROM processes;`).
4.  Configure your local syslog daemon (e.g., `rsyslog`) to forward logs. For `rsyslog`, create a file `/etc/rsyslog.d/60-osquery.conf` and add:
    `*.* @[ELASTIC_AGENT_IP]:514` (for UDP) or `*.* @@[ELASTIC_AGENT_IP]:514` (for TCP).
5.  Restart the osquery daemon to apply changes:
    -   Linux: `sudo systemctl restart osqueryd`
    -   macOS: `sudo launchctl stop com.facebook.osqueryd && sudo launchctl start com.facebook.osqueryd`
6.  Restart the syslog service: `sudo systemctl restart rsyslog`.

### For Windows (Event Log Collection):

1.  Navigate to the osquery installation directory, typically `C:\Program Files\osquery\`.
2.  Open `osquery.conf` in a text editor like Notepad (run as Administrator).
3.  Modify the `options` block to include the `windows_event_log` logger plugin:
    ```json
    "options": {
      "logger_plugin": "windows_event_log"
    }
    ```
4.  Ensure the `schedule` block contains queries relevant to your monitoring needs.
5.  Save the file and restart the service via PowerShell:
    `Restart-Service osqueryd`
6.  Verify that events are appearing in the Windows Event Viewer under **Applications and Services Logs > osquery**.

## Kibana set up steps

### For Syslog Input (Linux/macOS):
1.  Navigate to **Management > Integrations** in Kibana.
2.  Search for and select the **osquery** integration.
3.  Click **Add osquery**.
4.  In the configuration, select the **Syslog** input type.
5.  Set the **Syslog Host** to `0.0.0.0` to listen on all interfaces.
6.  Set the **Syslog Port** to `514` or `5514` (matching your vendor setup).
7.  Click **Save and continue** and then **Add agent policy to apply changes**.

### For Windows Event Log Input (Windows):
1.  Navigate to **Management > Integrations** and select **osquery**.
2.  Click **Add osquery** and choose the **Windows Event Log** input.
3.  In the **Channel Name** field, enter `Microsoft-Windows-osquery/Operational` (or the specific channel configured in `osquery.conf`).
4.  Select the desired **Log Level** (Information, Warning, Error).
5.  Click **Save and deploy** to push the configuration to your enrolled Elastic Agents.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Osquery to the Elastic Stack.

### 1. Trigger Data Flow on Osquery:
- **Generate status logs:** Restart the osquery daemon using `sudo systemctl restart osqueryd`. This will generate initialization logs and status messages.
- **Generate result logs:** Run a manual query via `osqueryi` if logging is shared, or wait for a scheduled query to execute. For example, add a temporary query to `/etc/osquery/osquery.conf` that monitors the `/etc/passwd` file.
- **Trigger system event:** Perform a specific action that a scheduled query is monitoring, such as creating a new user or logging in via SSH.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the following KQL filter: `data_stream.dataset : "osquery.log"`
4. Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `osquery.log`)
   - `osquery.result.name` (for query results) or `osquery.status.message` (for status logs)
   - `log.syslog.priority` (indicating the syslog severity/facility)
   - `host.name` (the name of the system running osquery)
   - `message` (containing the raw JSON or syslog payload)
5. Navigate to **Analytics > Dashboards** and search for "osquery" to view pre-built visualizations and verify data populates the charts.

# Troubleshooting

## Common Configuration Issues

-   **Logger Plugin Mismatch**: If `logger_plugin` is not set correctly in `osquery.conf`, logs may default to the `filesystem` plugin instead of `syslog` or `windows_event_log`. Verify the setting using `osqueryi --line "SELECT name, value FROM osquery_flags WHERE name = 'logger_plugin';"`.
-   **Syslog Forwarding Blocked**: Ensure that the local firewall (iptables/ufw) on the osquery host and the Elastic Agent host allows traffic on the configured syslog port (e.g., 514).
-   **Configuration Syntax Errors**: Osquery will fail to start if the `osquery.conf` file contains invalid JSON. Use a JSON validator or check the osquery status logs for "Error reading config" messages.

## Ingestion Errors

-   **Parsing Failures**: If logs appear in Kibana but are not parsed correctly, check the `error.message` field. This often happens if the `syslog` format sent by the vendor daemon does not match the RFC 3164 or RFC 5424 patterns expected by the Elastic Agent.
-   **Mapping Issues**: Ensure that the `data_stream.dataset` is correctly identified as `osquery.log`. If logs are appearing under a generic `syslog` dataset, the specific osquery processors in the integration will not run.
-   **Timestamp Mismatches**: If logs do not appear in the current time range, check for clock skew between the osquery host and the Elastic Stack. Verify the `@timestamp` field against the `event.ingested` field.

## Vendor Resources
- [Logging osquery - Read the Docs](https://osquery.readthedocs.io/en/stable/deployment/logging/)
- [Is it possible to send osquery output via syslog to a remote syslogd server on OS X? - Stack Overflow](https://stackoverflow.com/questions/78478673/is-it-possible-to-send-osquery-output-via-syslog-to-a-remote-syslogd-server-on-o)

## Documentation sites
- [Logging osquery - Read the Docs](https://osquery.readthedocs.io/en/stable/deployment/logging/)
- [Is it possible to send osquery output via syslog to a remote syslogd server on OS X? - Stack Overflow](https://stackoverflow.com/questions/78478673/is-it-possible-to-send-osquery-output-via-syslog-to-a-remote-syslogd-server-on-o)
