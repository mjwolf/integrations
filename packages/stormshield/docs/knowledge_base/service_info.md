# Service Info

## Common use cases

The Stormshield integration for Elastic enables the seamless ingestion and analysis of security and system events from Stormshield Network Security (SNS) appliances. By centralizing these logs, organizations can gain deep visibility into their network traffic and security posture.
- **Threat Detection and Response:** Monitor firewall logs in real-time to identify and respond to unauthorized access attempts, malware activity, or suspicious traffic patterns.
- **Compliance Auditing:** Maintain a comprehensive and searchable audit trail of administrative changes, user authentications, and network connections to satisfy regulatory requirements like GDPR, PCI-DSS, or HIPAA.
- **Network Performance Troubleshooting:** Analyze connection logs and system events to identify bottlenecks, configuration errors, or hardware issues impacting network availability.
- **Security Policy Validation:** Verify that firewall rules and NAT policies are functioning as intended by reviewing the logs generated by specific filtering rules.

## Data types collected

This integration can collect the following types of data from Stormshield SNS appliances:
- **Connection logs:** Details on established and closed sessions, including source/destination IP addresses, ports, and protocols.
- **Alarm logs:** Security events triggered by the Intrusion Prevention System (IPS), including mnemonic codes and severity levels.
- **Filter logs:** Logs generated by specific firewall rules, allowing for auditing of allowed and denied traffic.
- **Web logs:** Detailed information on HTTP/HTTPS traffic, including requested URLs, categories, and actions taken by the web filter.
- **Authentication logs:** Success and failure events for users logging into the network or the administration interface.
- **Data Formats:** Logs are ingested via Syslog in RFC5424 or LEGACY-LONG formats, ensuring compatibility with detailed message payloads.

## Compatibility

The Stormshield integration is compatible with **Stormshield Network Security (SNS)** appliances. It has been specifically validated against **SNS version 4.x** and higher. For optimal performance and field mapping accuracy, ensure the appliance is running a supported firmware version that allows for standard Syslog or CEF output.

## Scaling and Performance

- **Transport/Collection Considerations:** This integration primarily relies on the Syslog protocol. When configuring the transport, choosing between TCP and UDP is critical; TCP is highly recommended for production environments to ensure reliable delivery and to prevent data loss during network congestion, whereas UDP offers lower overhead but lacks delivery guarantees.
- **Data Volume Management:** To manage high log volumes, administrators should utilize the "Log level" settings within the SNS Filter - NAT rules. Selecting "Standard (connection log)" provides essential security data without the extreme volume generated by "Verbose" logging. Filtering specific log families in the SNS Notifications menu also ensures only relevant data is forwarded to the Elastic Agent.
- **Elastic Agent Scaling:** For high-throughput environments processing thousands of events per second, it is recommended to deploy multiple Elastic Agents behind a load balancer. A single Elastic Agent should be monitored for CPU and memory utilization; if resource saturation occurs, horizontal scaling by distributing the Syslog load across multiple Agent instances is the preferred approach.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** You must have an administrative account for the Stormshield SNS web interface with permissions to modify Notifications and Log settings.
- **Network Connectivity:** The Stormshield appliance must be able to reach the Elastic Agent's IP address on the configured Syslog port (e.g., UDP/TCP 514 or 9514).
- **Host Object Configuration:** A Host Object representing the Elastic Agent's IP address must be created in the SNS "Objects" database before configuring the Syslog profile.
- **License Requirements:** Ensure the appliance has an active license that includes logging and notification features.
- **Knowledge Requirements:** You should know the IP address of your Elastic Agent and have decided on the protocol (TCP/UDP) and port number to be used.

## Elastic prerequisites

- **Elastic Agent:** An Elastic Agent must be installed and enrolled in a policy via Fleet.
- **Integration Package:** The Stormshield integration must be added to the Elastic Agent policy.
- **Network Path:** Firewall rules must exist to allow traffic from the Stormshield appliance IP to the Elastic Agent on the specified Syslog port.

## Vendor set up steps

### For Syslog Collection:
1. Log in to your **Stormshield SNS web administration interface** using your administrative credentials.
2. Navigate to the **Configuration** menu, then select **Notifications > Logs - Syslog - IPFIX**.
3. Locate the **Syslog** section and toggle the slider to **ON** to enable the syslog forwarding service.
4. Click on the **Add a Syslog server** button in the configuration table to define a new destination for your logs.
5. In the configuration window, enter a **Name** (e.g., `ElasticAgent_Syslog`).
6. In the **IP address/FQDN** field, enter the IP address of the server hosting your Elastic Agent.
7. Select the **Protocol** (TCP or UDP). Ensure this matches the protocol you intend to configure in the Kibana integration settings.
8. Set the **Port** number (default is often 514). Note this port for the Kibana configuration step.
9. For **Format**, select the default `syslog` format or `CEF` based on your preference.
10. Click **OK** to save the server configuration.
11. In the **Advanced properties** section, locate the table of log families. Double-click the **Status** column for each category you wish to send (e.g., Traffic, Web, Filter, System) to change them to **Enabled**.
12. To ensure traffic logs are generated, navigate to **Configuration > Security policy > Filter - NAT**.
13. Select your active security policy and double-click a rule you wish to monitor.
14. In the **General** tab of the rule settings, locate the **Log level** dropdown and select `Standard (connection log)`.
15. Click **OK** and then click **Apply** in the main window to deploy the changes to the appliance.

## Kibana set up steps

### For Syslog Input:
1.  In Kibana, navigate to **Management > Integrations**.
2.  Search for **Stormshield** and select it.
3.  Click **Add Stormshield** to add the integration to an Elastic Agent policy.
4.  Under the **Syslog** configuration section, define the following fields:
    *   **Syslog Host**: Set this to `0.0.0.0` to listen on all interfaces or the specific IP address of the Elastic Agent host.
    *   **Syslog Port**: Enter the port number you configured on the Stormshield appliance (e.g., `514`).
    *   **Protocol**: Select the protocol (`tcp` or `udp`) that matches your SNS appliance configuration.
5.  Expand the **Advanced options** if you need to adjust internal timeouts or custom tags.
6.  Click **Save and continue** to save the integration settings.
7.  Click **Save and deploy changes** to push the updated policy to your enrolled Elastic Agents.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Stormshield to the Elastic Stack.

### 1. Trigger Data Flow on Stormshield:
- **Generate authentication event:** Log out of the Stormshield SNS administration interface and log back in. This will generate an "Auth" log entry.
- **Generate configuration event:** Navigate to any configuration module, make a minor change (like a description), and click "Apply".
- **Generate web traffic:** From a client machine whose traffic is routed through the Stormshield firewall, browse to several different websites to generate "Web" and "Connection" logs.
- **Trigger filter event:** Attempt to connect to a service that is explicitly blocked by a firewall rule to generate a "Filter" log entry.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view or the specific integration data view.
3. Enter the following KQL filter: `data_stream.dataset : "stormshield.log"`
4. Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `stormshield.log`)
   - `source.ip` and/or `destination.ip` (to verify network context)
   - `event.action` or `event.outcome` (to verify the result of the connection or alarm)
   - `stormshield.sns.mnemonic` (the specific Stormshield event code)
   - `message` (containing the raw log payload from the appliance)
5. Navigate to **Analytics > Dashboards** and search for "Stormshield" to view pre-built visualizations and confirm that charts are populating with data.

# Troubleshooting

## Common Configuration Issues

- **Port Conflict**: If the Elastic Agent fails to start the Syslog listener, verify that no other service is already using the configured port (e.g., a native rsyslog service on Linux). Use `netstat -tulpn | grep <port>` to check for conflicts.
- **Firewall Obstruction**: If no logs are reaching the Agent, check the local firewall on the Elastic Agent host (e.g., `iptables` or `firewalld`) to ensure the Syslog port is permitted for incoming traffic.
- **Policy Not Applied**: On the Stormshield SNS appliance, ensure you clicked "Apply" after making changes in the Filter - NAT or Notifications menus. Changes are not active until the policy is deployed.
- **Protocol Mismatch**: Ensure both the SNS appliance and the Elastic Agent integration are set to the same protocol (both TCP or both UDP). A mismatch will result in no data ingestion or connection resets.

## Ingestion Errors
- **Parsing Failures**: If logs appear in Kibana but contain a `_grokparsefailure` or `_jsonparsefailure` tag, verify that the "Format" on the SNS appliance is set to either `RFC5424` or `LEGACY-LONG`. Using a "Short" format may lead to parsing errors.
- **Timestamp Mismatch**: If logs appear with the wrong timestamp, check the time synchronization (NTP) settings on both the Stormshield appliance and the Elastic Agent host.
- **Missing Fields**: If specific fields like `source.ip` are missing, ensure the relevant log category (e.g., "Connection") is enabled in the "Logs enabled" table on the SNS appliance.

## Vendor Resources
- [Syslog tab - Stormshield Documentation](https://documentation.stormshield.eu/SNS/v4/en/Content/User_Configuration_Manual_SNS_v4/Logs-syslog/Syslog_tab.htm)
- [Configuring logs - Stormshield Documentation](https://documentation.stormshield.eu/SNS/v4/en/Content/Description_of_Audit_logs/Configure_logs.htm)

## Documentation sites

- [Stormshield SNS | Elastic integrations](https://www.elastic.co/docs/reference/integrations/stormshield)
- [Configuring logs - Stormshield Documentation](https://documentation.stormshield.eu/SNS/v4/en/Content/Description_of_Audit_logs/Configure_logs.htm)
