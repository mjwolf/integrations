# Service Info

## Common use cases

The `iptables` integration for Elastic allows users to ingest, parse, and visualize network traffic logs generated by the Linux kernel's netfilter framework. By collecting these logs, security teams and system administrators can gain deep visibility into network activity at the host level.
- **Security Auditing and Intrusion Detection:** Monitor dropped packets from unauthorized IP addresses or suspicious ports to identify potential reconnaissance or brute-force attacks against the infrastructure.
- **Network Troubleshooting:** Analyze rejected or dropped traffic to diagnose connectivity issues between services, ensuring that firewall rules are correctly configured for legitimate application traffic.
- **Compliance Monitoring:** Maintain a detailed audit trail of all inbound and outbound network connections as required by regulatory frameworks like PCI-DSS, HIPAA, or SOC2.
- **Policy Verification:** Confirm that newly implemented firewall policies are functioning as intended by logging "accepted" traffic during a testing phase before locking down the environment.

## Data types collected
This integration can collect the following types of data:
- **Firewall Logs:** Captured directly from the Linux kernel logging subsystem via a syslog daemon.
- **Connection Events:** Details on accepted, dropped, or rejected packets including source/destination IP addresses and ports.
- **Protocol Information:** Metadata regarding the network protocols used (e.g., TCP, UDP, ICMP).
- **Format:** Logs are typically received in standard Syslog format or CEF if transformed by an intermediary log shipper.
- **Paths:** While logs originate in the kernel, they are often buffered in `/var/log/messages`, `/var/log/kern.log`, or `/var/log/syslog` before being forwarded.

## Compatibility

The **iptables** integration is compatible with:
- **Linux Distributions:** Any distribution utilizing `iptables` and the Netfilter framework, including Ubuntu (18.04+), Debian (10+), RHEL/CentOS (7, 8, 9), and Fedora.
- **Syslog Daemons:** Requires `rsyslog` (v8.0+) or `syslog-ng` for log forwarding.
- **Elastic Agent:** Compatible with version **8.0 and higher**.

## Scaling and Performance
- **Transport/Collection Considerations:** When choosing between UDP and TCP for syslog forwarding, consider that UDP offers lower latency and less overhead on the source system but does not guarantee delivery. TCP is recommended for environments where log integrity is critical, though it may introduce backpressure if the Elastic Agent is unavailable.
- **Data Volume Management:** To prevent log flooding and system performance degradation, use the `limit` module in `iptables` (e.g., `-m limit --limit 5/min`) to throttle the rate at which logs are generated. Additionally, use specific log prefixes to filter only high-priority security events for forwarding to the Elastic Stack.
- **Elastic Agent Scaling:** For high-volume environments generating thousands of log lines per second, deploy multiple Elastic Agents behind a load balancer. Ensure that the host running the Elastic Agent has sufficient CPU and memory resources to handle the parsing load, as `iptables` logs often require regex-heavy processing.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Root or sudo permissions are required on the Linux host to modify `iptables` rules and `rsyslog` configurations.
- **Package Requirements:** Ensure the `iptables` package is installed. For persistence, `iptables-persistent` (Debian/Ubuntu) or `iptables-services` (RHEL/CentOS) is recommended.
- **Network Connectivity:** The host must be able to reach the Elastic Agent over the network via the port configured for Syslog (default is often 514 or 9514).
- **Service Status:** The `rsyslog` service must be active and enabled to facilitate log forwarding from the kernel to the Agent.

## Elastic prerequisites
- **Elastic Agent:** An Elastic Agent must be installed and enrolled in Fleet with a policy that includes the `iptables` integration.
- **Connectivity:** Ensure the Elastic Agent is reachable from the data source and that its listener is not blocked by local firewalls.
- **Version:** Elastic Stack version 7.x or 8.x is recommended for full dashboard and field mapping support.

## Vendor set up steps

### For Syslog Forwarding via rsyslog:

1. **Create a Logging Chain:**
   Create a dedicated chain in `iptables` to handle both logging and the subsequent action (like dropping the packet).
   ```bash
   sudo iptables -N LOG_AND_DROP
   ```

2. **Add Logging Rule with Prefix:**
   Add a rule to the new chain. Use a unique prefix to make filtering in `rsyslog` easier.
   ```bash
   sudo iptables -A LOG_AND_DROP -j LOG --log-prefix "iptables-dropped: " --log-level 4
   ```

3. **Complete the Chain Action:**
   Add the terminal action for the packet after it has been logged.
   ```bash
   sudo iptables -A LOG_AND_DROP -j DROP
   ```

4. **Apply to Chains:**
   Direct traffic to your new logging chain. For example, to log all packets that don't match existing rules:
   ```bash
   sudo iptables -A INPUT -j LOG_AND_DROP
   ```

5. **Configure rsyslog Filter:**
   Create a new configuration file `/etc/rsyslog.d/60-iptables.conf` and add the following logic to forward logs to the Elastic Agent:
   ```text
   if $msg contains 'iptables-dropped: ' then @@<ELASTIC_AGENT_IP>:9001
   & stop
   ```
   *Note: Replace `<ELASTIC_AGENT_IP>` with your actual Agent IP and `9001` with your configured port.*

6. **Restart rsyslog:**
   Apply the changes by restarting the service:
   ```bash
   sudo systemctl restart rsyslog
   ```

7. **Ensure Persistence:**
   Save the `iptables` rules so they persist across reboots:
   - **Ubuntu/Debian:** `sudo netfilter-persistent save`
   - **RHEL/CentOS:** `sudo iptables-save | sudo tee /etc/sysconfig/iptables`

## Kibana set up steps

1. **Navigate to Integrations:**
   Log into Kibana and go to **Management > Integrations**. Search for **iptables** and click on it.

2. **Add Iptables Integration:**
   Click **Add iptables**. Select an existing Agent Policy or create a new one.

3. **Configure the Integration Settings:**
   In the integration configuration screen, find the **Syslog** input section.
   - **Syslog Host:** Set to `0.0.0.0` to listen on all interfaces or provide a specific IP.
   - **Syslog Port:** Enter the port number you configured in the `rsyslog` step (e.g., `9514`).
   - **Protocol:** Select either **UDP** or **TCP** to match your `rsyslog` configuration.

4. **Advanced Settings (Optional):**
   Expand the integration settings to configure specific tags or internal data stream names if required for your environment's naming conventions.

5. **Save and Deploy:**
   Click **Save and continue**, then **Roll out changes**. The Elastic Agent will now begin listening for incoming `iptables` logs on the specified port.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from the Linux host to the Elastic Stack.

### 1. Trigger Data Flow on Linux Host:
- **Generate a dropped packet event:** If you created a rule to log dropped traffic, attempt to connect to a port that is not open on the host from a remote machine (e.g., `telnet <host-ip> 9999`).
- **Trigger a specific log rule:** Use `curl` or `ssh` to trigger a rule you specifically created for logging (e.g., `ssh localhost` if you have a rule for port 22).
- **Verify kernel logs locally:** Run `sudo dmesg | tail` or `tail -f /var/log/syslog` to confirm that the `iptables` messages are being generated with the correct prefix.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the following KQL filter: `data_stream.dataset : "iptables.log"`
4. Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `iptables.log`)
   - `source.ip` (the IP of the machine that triggered the rule)
   - `destination.port` (the port targeted in the test)
   - `iptables.log_prefix` (the custom prefix you defined in the iptables rule)
   - `message` (containing the raw log payload from the kernel)
5. Navigate to **Analytics > Dashboards** and search for "iptables" to view pre-built visualizations showing traffic trends and top source IPs.

# Troubleshooting

## Common Configuration Issues

- **Mismatched Log Prefix**: If the prefix set in the `iptables` rule (`--log-prefix`) does not match the string in the `rsyslog` filter (`if $msg contains...`), logs will not be forwarded. Ensure these strings are identical, including trailing spaces.
- **Firewall Blocking Agent Port**: The host running the Elastic Agent may have its own `iptables` or `firewalld` rules blocking the Syslog port (e.g., 9001). Ensure the port is open for inbound traffic from the source logs.
- **UDP Packet Loss**: If using UDP and logs are missing, check for network congestion or buffer overflows. Switching to TCP in both `rsyslog` and the Elastic Agent configuration is the recommended fix.
- **Rules Not Persistent**: If logs stop appearing after a reboot, the `iptables` rules were likely not saved. Verify the rules are still present using `sudo iptables -L`.

## Ingestion Errors

- **Parsing Failures**: Check the `error.message` field in Discover. This often indicates that the raw log message format differs from the standard kernel log format expected by the integration.
- **Timestamp Mismatches**: If logs appear "out of order" or in the future/past, verify that the system time on the Linux host is synchronized using NTP.
- **Field Mapping Mismatches**: If specific fields like `source.ip` are missing, examine the `message` field to see if the `iptables` log contains the expected `SRC=` and `DST=` keys.

## Vendor Resources

- [How to Write iptables Logs to a Separate File - Baeldung](https://www.baeldung.com/linux/iptables-log-separate-file)
- [How to configure syslog to log the iptables messages to a different log file - Red Hat](https://access.redhat.com/solutions/400733)

## Documentation sites

- [How to Write iptables Logs to a Separate File - Baeldung](https://www.baeldung.com/linux/iptables-log-separate-file)
- [How to configure syslog to log the iptables messages to a different log file - Red Hat](https://access.redhat.com/solutions/400733)
- Refer to the official vendor website for additional resources.
