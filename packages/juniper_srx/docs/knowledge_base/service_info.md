# Service Info

## Common use cases
The Juniper SRX integration provides deep visibility into your network infrastructure by ingesting logs from Juniper's high-performance security gateways. This integration is essential for organizations that need to monitor their perimeter security and internal network traffic in real-time.

1.  **Security Threat Detection:** 
    *   Monitor firewall logs to identify and alert on denied connection attempts.
    *   Detect potential port scans and brute-force attacks.
    *   Correlate known malicious IP addresses interacting with your network using threat intelligence integration.
2.  **Network Traffic Analysis:** 
    *   Analyze session logs (`RT_FLOW_SESSION_CREATE`, `RT_FLOW_SESSION_CLOSE`) to understand bandwidth consumption patterns.
    *   Identify "top talkers" and application usage across different security zones.
    *   Utilize standard ECS fields like `source.ip`, `destination.ip`, `network.bytes`, and `network.packets` for cross-source analysis.
3.  **Compliance and Auditing:** 
    *   Maintain a tamper-evident record of administrative logins and CLI command execution (`UI_COMMIT_COMPLETED`).
    *   Satisfy regulatory requirements like PCI-DSS (Requirement 10), HIPAA, or SOC2 by tracking all access to network resources.
4.  **System Health Monitoring:** 
    *   Track hardware status, including power supplies, fans, and temperature sensors.
    *   Monitor routing protocol updates (OSPF/BGP) and process restarts.
    *   Use the `juniper.srx.tag` field to identify specific Junos components generating errors.

## Data types collected
This integration collects log data via the **juniper_srx.log** datastream. It supports several categories of Juniper Junos telemetry converted into Elastic Common Schema (ECS) format:

*   **Security Logs (Traffic):** Detailed records of traffic passing through the device. These include `RT_FLOW_SESSION_CREATE`, `RT_FLOW_SESSION_CLOSE`, and `RT_FLOW_SESSION_DENY` events, providing visibility into session duration, bytes transferred, and policy actions.
*   **System Logs (Control Plane):** Records related to the operation of the device itself. This includes user authentication (SSH/WebUI), configuration commits, and system process notifications.
*   **UTM (Unified Threat Management) Logs:** Logs generated by security features such as Anti-Virus, Web Filtering, and Content Filtering.
*   **IDP (Intrusion Detection and Prevention) Logs:** High-fidelity alerts detailing identified attacks, signature matches, and the specific actions taken by the IDP engine.
*   **Data Formats:** Logs are ingested in Syslog format. The integration supports both standard Junos format and structured-data format (RFC 5424).
*   **Transport Protocols:** Supports log delivery via **UDP** or **TCP**, typically on port `514` or a custom-defined port.

## Compatibility
- **Software:** This integration is compatible with **Juniper Junos OS** version **12.1X46** and later.
- **Hardware:** It is designed to work with all hardware platforms in the **Juniper SRX Series**, including:
    - **Branch SRX:** SRX300, SRX320, SRX340, SRX345, SRX380.
    - **Mid-range/High-end:** SRX1500, SRX4100, SRX4200, SRX4600, SRX5400, SRX5600, SRX5800.
- **Virtual:** Fully supports the virtual **vSRX** and **vSRX 3.0** instances across all supported hypervisors (KVM, VMware ESXi, AWS, Azure, GCP).
- **Elastic Stack:** Requires version **7.16.0** or later.

## Scaling and Performance
1.  **Stream Mode Utilization:** For high-volume environments (exceeding 500 events per second), it is critical to use **Stream Mode** logging. This offloads log generation from the Routing Engine (RE) to the Packet Forwarding Engine (PFE), preventing control plane instability.
2.  **Elastic Agent Distribution:** In large-scale deployments with multiple SRX clusters, deploy multiple Elastic Agents behind a load balancer (like F5 or HAProxy) to distribute the Syslog ingestion load and provide high availability.
3.  **Transport Protocol Selection:** Use **TCP** for reliable delivery if the network path between the SRX and the Elastic Agent is prone to congestion, as UDP may drop packets under heavy load.
4.  **Worker Optimization:** In the Elastic Agent configuration, increase the number of worker threads for the UDP/TCP input if the `processing_time` for events increases or if the agent buffer fills up.

# Set Up Instructions

## Vendor prerequisites
- **Administrative Access:** Root-level or super-user access to the Juniper SRX CLI via SSH or console is required to apply configuration changes.
- **Network Connectivity:** The SRX device must have a clear network path to the Elastic Agent's IP address. Ensure intermediate firewalls allow traffic on the chosen Syslog port (e.g., **UDP/TCP 514** or **9514**).
- **Security Policy Logging:** Logging must be explicitly enabled on specific security policies; otherwise, traffic logs will not be generated even if the global syslog server is configured.
- **Correct Time Synchronization:** Ensure the SRX device is synchronized via NTP. Timestamps are critical for correlation; using the `set security log utc-timestamp` command is required for consistent parsing by the Elastic Agent.

## Elastic prerequisites
- **Elastic Stack Version:** This integration requires Elastic Stack version **7.16.0** or later for full ECS mapping support.
- **Elastic Agent:** An active Elastic Agent must be installed on a host reachable by the Juniper SRX and enrolled in Fleet.
- **Integration Installed:** The Juniper SRX integration must be added to an Elastic Agent policy via Kibana.
- **Inbound Port Access:** The host running the Elastic Agent must have its local OS firewall (iptables/ufw/Windows Firewall) configured to allow inbound traffic on the port specified in the integration settings (e.g., **port 514**).

## Vendor set up steps

### For Syslog and Security Stream Collection:
1.  Access the SRX CLI and enter configuration mode:
    ```bash
    configure
    ```
2.  **Configure System Logging:** Captures control plane and OS events. Replace `<Agent_IP>` with your Elastic Agent's IP.
    ```bash
    set system syslog host <Agent_IP> any any
    set system syslog source-address <SRX_Source_IP>
    ```
3.  **Enable Security Log Stream Mode:** This is the recommended high-performance method.
    ```bash
    set security log mode stream
    set security log source-address <SRX_Source_IP>
    set security log utc-timestamp
    ```
4.  **Define the Log Stream:** Create a stream targeting the Elastic Agent.
    ```bash
    set security log stream elastic-agent-stream format syslog
    set security log stream elastic-agent-stream category all
    set security log stream elastic-agent-stream host <Agent_IP>
    set security log stream elastic-agent-stream host port 514
    ```
5.  **Apply Logging to Policies:** You must enable logging on each policy you want to track.
    ```bash
    set security policies from-zone trust to-zone untrust policy ALLOW-INTERNAL then log session-close
    ```
6.  **Commit Configuration:**
    ```bash
    commit check
    commit
    ```

## Kibana set up steps

1.  In Kibana, navigate to **Management** > **Integrations**.
2.  Search for **Juniper SRX** and click on the integration tile.
3.  Click **Add Juniper SRX**.
4.  Configure the input settings using the following fields:
    - **Syslog Host** (`syslog_host`): Set this to `0.0.0.0` to listen on all available interfaces or the specific IP of the Agent host.
    - **Syslog Port** (`syslog_port`): Enter the port number (e.g., `514` or `9514`).
    - **Protocol** (`protocol`): Select `udp` or `tcp` to match your SRX configuration.
5.  Review **Advanced Options**:
    - **Internal Stack Log Level**: Typically set to `info`.
    - **Custom Configurations**: Use this to add specific YAML tags or processors if required for your environment.
6.  Select the **Agent Policy** where you want to add this integration.
7.  Click **Save and continue**. The Elastic Agent will automatically receive the update and begin listening for Juniper logs.

# Validation Steps

## 1. Trigger Data Flow on Juniper SRX:
1.  **Generate Traffic:** From a host behind the SRX, initiate a connection that matches a security policy where you enabled logging (e.g., `curl ).
2.  **Verify Local Stats:** Run the following command on the SRX to ensure packets are leaving the device:
    ```bash
    show security log stats
    ```
3.  **Trigger System Log:** Enter and exit configuration mode to generate a management log:
    ```bash
    configure
    exit
    ```

## 2. Check Data in Kibana:
1.  Navigate to **Analytics** > **Discover**.
2.  Enter the following filter query to isolate the integration data:
    `data_stream.dataset : "juniper_srx.log"`
3.  Verify that records appear in the table. Expand a document and check for:
    - `source.ip` and `destination.ip`
    - `event.action` (e.g., `session-close`)
    - `juniper.srx.tag` (e.g., `RT_FLOW`)
    - `observer.vendor`: `Juniper`
4.  Navigate to **Analytics** > **Dashboard** and search for the **[Juniper SRX] Overview** dashboard to visualize the data.

# Troubleshooting

## Common Configuration Issues
- **Stream Mode Inactivity**: If traffic logs are missing but system logs are present, ensure `set security log mode stream` is set. 
- **Policy Logging Missing**: Verify that `then log session-close` is explicitly added to the specific security policy. Use `show security policies detail` to check.
- **Timestamp Mismatches**: If logs appear with the wrong time, ensure `set security log utc-timestamp` is configured on the SRX.
- **Source Address Binding**: If logs aren't reaching the agent, verify `set security log source-address` is set to an IP routable to the Agent.

## Ingestion Errors
- **Parsing Failures**: Check for `error.message` in Discover. Ensure the SRX is using `format syslog` in the stream definition.
- **Truncated Logs**: Large IDP logs may be truncated over UDP. Switch the SRX and integration to **TCP** if logs are being cut off.
- **Mapping Issues**: Ensure the Elastic Agent is not using a generic "UDP/TCP" input that overrides the specific Juniper integration.

## Vendor Resources
- [Juniper KB16509: Configure Traffic Logging for SRX Devices](https://supportportal.juniper.net/s/article/SRX-Getting-Started-Configure-Traffic-Logging-Security-Policy-Logs-for-SRX-Branch-Devices)
- [Junos CLI Reference - Syslog Hierarchy](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/statement/syslog-edit-system.html)

# Documentation sites
- [Juniper Networks - SRX Series Documentation](https://www.juniper.net/documentation/product/en/us/srx-series/)
- Junos OS System Log Messages Reference
- [Elastic Common Schema (ECS) Reference](https://www.elastic.co/docs/reference/ecs)