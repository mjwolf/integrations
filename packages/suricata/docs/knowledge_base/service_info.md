# Service Info

## Common use cases

Suricata is a high-performance, open-source Network Analysis and Threat Detection engine used by security teams globally for intrusion detection (IDS), intrusion prevention (IPS), and network security monitoring (NSM). This integration allows users to ingest Suricata's comprehensive EVE JSON logs into the Elastic Stack for centralized analysis and alerting.
- **Threat Detection and Alerting:** Monitor real-time security alerts generated by Suricata signature matches to identify malicious activity, such as SQL injection, malware command-and-control, or unauthorized access attempts.
- **Network Visibility and Protocol Analysis:** Collect detailed metadata for DNS queries, TLS handshakes, and HTTP requests to gain deep visibility into network traffic patterns and identify anomalous behavior.
- **Incident Response and Forensics:** Utilize stored flow and transaction logs to reconstruct network sessions and investigate the scope of security incidents after an alert has been triggered.
- **Performance and Health Monitoring:** Track Suricata's internal statistics and performance metrics to ensure the engine is processing traffic efficiently without packet drops.

## Data types collected

This integration can collect the following types of data:
- **Alert Logs:** Detailed information regarding signature matches, including severity, category, and signature ID.
- **Protocol Metadata:** JSON-formatted logs for specific protocols including DNS queries/responses, HTTP request/response headers, TLS handshake details (SNI, certificates), and SMTP transactions.
- **Flow Records:** Summarized connection data including source/destination IP addresses, ports, protocols, byte counts, and timestamps.
- **File Metadata:** Information about files identified in transit, including magic numbers, file sizes, and MD5/SHA256 hashes if configured.
- **Stats:** Internal Suricata performance metrics and counters.
- **Data Formats:** Logs are primarily collected in **EVE JSON** format, typically transported via **Syslog** (UDP or TCP) or read directly from log files like `/var/log/suricata/eve.json`.

## Compatibility

This integration is compatible with **Suricata** version 6.x, 7.x, and the development branch (9.0.0-dev). It requires Suricata to be configured to output logs in the EVE JSON format, which has been the standard for Suricata's extensible logging for several major releases.

## Scaling and Performance

- **Transport/Collection Considerations:** For most environments, logfile collection (Method 1) is recommended. Reading from a local file allows the Elastic Agent to handle spikes in log volume by utilizing the filesystem as a buffer, preventing data loss during periods of high network activity. In contrast, using Syslog over UDP (Method 2) may result in dropped packets if the network or the Agent becomes saturated, though TCP Syslog can mitigate this at the cost of slight performance overhead on the Suricata host.
- **Data Volume Management:** Suricata can generate an immense volume of data, particularly when `flow` and `netflow` event types are enabled. To manage data volume, administrators should selectively enable only necessary event types in the `suricata.yaml` file. For example, disabling `flow` logs while keeping `alert`, `dns`, and `tls` can significantly reduce storage requirements while maintaining high security visibility.
- **Elastic Agent Scaling:** In high-throughput environments (e.g., 10Gbps+ links), a single Elastic Agent may become a bottleneck for JSON parsing. It is recommended to deploy dedicated Agents on high-performance hardware or distribute the load across multiple Agents if Suricata is running in a clustered or load-balanced configuration. Monitor the CPU usage of the Agent to ensure it can keep up with the JSON ingestion rate.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Root or sudo-level access to the Suricata host is required to modify configuration files and restart services.
- **Suricata Installation:** Suricata must be installed and properly configured to monitor a network interface or process PCAP files.
- **Network Connectivity:** If using the Syslog method, the Suricata host must have network connectivity to the Elastic Agent on the configured Syslog port (e.g., UDP/TCP 514 or a custom port).
- **Configuration Knowledge:** Familiarity with the `suricata.yaml` configuration structure and the location of log files (default is often `/var/log/suricata/`).
- **Disk Space:** Ensure sufficient disk space is available for the `eve.json` file if using the logfile collection method, as these files can grow rapidly.

## Elastic prerequisites

- **Elastic Agent:** An Elastic Agent must be installed and enrolled in Fleet on a host that has access to the Suricata log files or can receive Syslog traffic.
- **Version Requirements:** It is recommended to use the latest version of the Elastic Stack (Elasticsearch, Kibana, and Fleet) for full dashboard support.
- **Integration Permissions:** The user configuring the integration in Kibana must have the `manage_integrations` cluster privilege.

## Vendor set up steps

### For Logfile Collection (Recommended):
1.  Log in to the Suricata server and navigate to the configuration directory, typically `/etc/suricata/`.
2.  Back up your current configuration: `sudo cp /etc/suricata/suricata.yaml /etc/suricata/suricata.yaml.backup`.
3.  Open the configuration file: `sudo nano /etc/suricata/suricata.yaml`.
4.  Locate the `outputs:` section and find the `- eve-log:` entry.
5.  Configure the output as follows:
    ```yaml
    outputs:
      - eve-log:
          enabled: yes
          filetype: regular
          filename: /var/log/suricata/eve.json
          types:
            - alert
            - anomaly
            - http
            - dns
            - tls
            - files
            - smtp
            - flow
            - stats
    ```
6.  Save the file and exit the editor.
7.  Restart the Suricata service to apply changes: `sudo systemctl restart suricata`.
8.  Verify that the log file is being populated: `tail -f /var/log/suricata/eve.json`.

### For Syslog Collection:
1.  Follow steps 1-3 from the Logfile method to edit `suricata.yaml`.
2.  Modify the `- eve-log:` section to use the `syslog` filetype:
    ```yaml
    outputs:
      - eve-log:
          enabled: yes
          filetype: syslog
          identity: "suricata"
          facility: local5
          level: Info
          types:
            - alert
            - dns
            - tls
    ```
3.  Configure your local syslog daemon (e.g., rsyslog) to forward these logs. Create `/etc/rsyslog.d/90-suricata.conf`:
    ```text
    local5.* @<ELASTIC_AGENT_IP>:<PORT>
    ```
4.  Restart both services:
    ```bash
    sudo systemctl restart rsyslog
    sudo systemctl restart suricata
    ```

## Kibana set up steps

### For Logfile Input:
1.  In Kibana, navigate to **Management > Integrations**.
2.  Search for and select the **Suricata** integration.
3.  Click **Add Suricata**.
4.  Under the **Log file** configuration section, ensure **Collect logs from file** is enabled.
5.  In the **Paths** field, enter the absolute path to your EVE JSON file: `/var/log/suricata/eve.json`.
6.  Scroll down and click **Save and continue**, then select the appropriate Agent Policy to deploy the changes.

### For Syslog Input:
1.  Navigate to **Management > Integrations** and select **Suricata**.
2.  Click **Add Suricata**.
3.  Enable the **Syslog** input option.
4.  Set the **Syslog Host** (e.g., `0.0.0.0` to listen on all interfaces).
5.  Set the **Syslog Port** to match your rsyslog configuration (e.g., `514` or `9001`).
6.  Ensure the **Protocol** (UDP or TCP) matches your sender.
7.  Click **Save and continue** and deploy to the Agent Policy.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Suricata to the Elastic Stack.

### 1. Trigger Data Flow on Suricata:
- **Generate IDS Alert:** From a machine on the monitored network, run a command that triggers a standard Suricata rule, such as: `curl http://testmyids.com`. This should generate an alert in `eve.json`.
- **Generate DNS Traffic:** Perform several DNS lookups to generate protocol metadata: `nslookup elastic.co` or `dig google.com`.
- **Generate HTTPS Traffic:** Browse to an HTTPS website or run `curl -I https://www.elastic.co` to generate TLS and Flow logs.
- **Restart Service:** If no logs appear, restart Suricata to trigger the "stats" event: `sudo systemctl restart suricata`.

### 2. Check Data in Kibana:
1.  Navigate to **Analytics > Discover**.
2.  Select the `logs-*` data view.
3.  Enter the following KQL filter: `data_stream.dataset : "suricata.eve"`
4.  Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
    - `event.dataset` (should be `suricata.eve`)
    - `source.ip` (the IP of the machine that triggered the traffic)
    - `destination.ip` (the IP of the target service)
    - `suricata.eve.alert.signature` (if an alert was triggered)
    - `suricata.eve.event_type` (e.g., `alert`, `dns`, `tls`)
    - `message` (containing the raw EVE JSON payload)
5.  Navigate to **Analytics > Dashboards** and search for "Suricata" to view the pre-built **[Logs Suricata] Overview** dashboard.

# Troubleshooting

## Common Configuration Issues

- **Facility Mismatch**: If Suricata is configured with `facility: local5` but rsyslog is filtering for a different facility, logs will not be forwarded. Ensure the facility in `suricata.yaml` matches the logic in your `/etc/rsyslog.d/` configuration.
- **Firewall Blocking**: Often, the host firewall (iptables/ufw) on the Elastic Agent machine blocks incoming traffic on the custom syslog port. Ensure the port (e.g., 1514) is explicitly allowed for the Suricata sensor's IP.
- **SELinux/AppArmor Interference**: On RHEL/CentOS or Ubuntu systems, security modules may prevent the syslog daemon from sending traffic over the network. Check audit logs (`/var/log/audit/audit.log`) for "denied" messages related to rsyslog network access.
- **Suricata Service Failure**: If Suricata fails to start after modifying the YAML, use `suricata -T -c /etc/suricata/suricata.yaml` to test the configuration for syntax errors.

## Ingestion Errors

- **JSON Parsing Failures**: If the `message` field is populated in Kibana but fields like `suricata.eve.*` are missing, the JSON may be malformed or truncated. This often happens with UDP if the MTU is exceeded; consider switching to TCP.
- **Timestamp Mismatches**: If logs appear in the past or future, verify that the Suricata sensor host and the Elastic Agent host are synchronized via NTP.
- **Field Mapping Issues**: Check the `error.message` field in Discover. If you see "mapping errors," ensure you are using the latest version of the Suricata integration package which contains the correct ECS mappings.

## Vendor Resources

- [15.1.1. Eve JSON Output — Suricata 9.0.0-dev documentation](https://docs.suricata.io/en/latest/output/eve/eve-json-output.html)
- [Configuring logging of Suricata events. - Kaspersky](https://support.kaspersky.com/xdr-expert/1.1.9/265590)

## Documentation sites

- [15.1.1. Eve JSON Output — Suricata 9.0.0-dev documentation](https://docs.suricata.io/en/latest/output/eve/eve-json-output.html)
- Refer to the official Suricata documentation for version-specific configuration details.
