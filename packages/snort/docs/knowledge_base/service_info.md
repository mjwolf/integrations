# Service Info

The Snort integration allows for the seamless ingestion and analysis of network intrusion detection system (NIDS) logs within the Elastic Stack. By capturing real-time alerts generated by Snort's rule engine, security analysts can visualize threats, identify patterns of malicious activity, and correlate network events with other data sources across their infrastructure.

## Common use cases

The Snort integration for Elastic allows users to ingest, parse, and visualize alerts from one of the world's most widely deployed Open Source Intrusion Prevention Systems (IPS) and Intrusion Detection Systems (IDS). By bringing Snort logs into the Elastic Stack, security analysts can centralize network security monitoring and correlate network-based threats with other host-based or cloud-based telemetry.
- **Threat Detection Monitoring:** Real-time monitoring of network traffic for known attack patterns, exploits, and anomalies identified by Snort signatures.
- **Incident Response and Investigation:** Rapidly search through historical Snort alerts to identify the scope of a breach and determine the source and destination of malicious traffic.
- **Security Posture Analysis:** Analyze trends in alert volume and signature hits to identify misconfigured systems or recurring threats within the environment.
- **Compliance Reporting:** Maintain a centralized, searchable audit trail of network security events to meet regulatory requirements for continuous monitoring and incident logging.

## Data types collected

This integration can collect the following types of data:
- **Intrusion Alerts:** Detailed logs generated when network traffic matches predefined Snort rules and signatures.
- **Syslog Data:** Alert messages formatted for syslog delivery, typically including timestamps, priorities, and facility codes.
- **Network Metadata:** Extraction of source and destination IP addresses, port numbers, and protocol types (TCP, UDP, ICMP).
- **Rule Metadata:** Information regarding the specific Snort rule triggered, including the Signature ID (SID) and classification.
- **Log Formats:** Primarily Syslog (RFC 3164 or RFC 5424) or JSON-formatted alerts depending on the Snort output plugin configuration.
- **Default Paths:** Logs are often processed via `/var/log/snort/` or captured directly from the local syslog service (e.g., `/var/log/syslog` or `/var/log/auth.log`).

## Compatibility

This integration is designed for **Snort 3** (also known as Snort++) utilizing the Lua-based configuration system. It is also compatible with **Snort 2.x** installations that output data in standard Syslog format. It supports Linux-based distributions where **rsyslog** or **syslog-ng** is present.

## Scaling and Performance

- **Transport/Collection Considerations:** For Snort syslog collection, UDP is often preferred for high-speed network environments to minimize latency impact on the logging daemon, though TCP is recommended for guaranteed delivery when traversing unreliable network segments. When using `rsyslog` as an intermediary, ensure the queue sizes are tuned to prevent message loss during burst traffic.
- **Data Volume Management:** To prevent overwhelming the Elastic Stack, it is critical to tune Snort rules at the source. This includes disabling high-volume/low-value rules, using "thresholding" or "suppression" within `snort.conf` to limit the number of alerts for a single event, and filtering out known-safe internal traffic.
- **Elastic Agent Scaling:** A single Elastic Agent can typically handle thousands of Snort events per second; however, in high-throughput environments (10Gbps+ links), consider deploying multiple Elastic Agents behind a network load balancer. Ensure the Agent host has sufficient CPU resources for the parsing and processing overhead of the Snort ingest pipeline.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** You must have root or sudo privileges on the machine where Snort is installed to modify configuration files and restart services.
- **Network Connectivity:** Ensure that the Snort host can reach the Elastic Agent host over the network. If a firewall is present, the specific TCP or UDP port (e.g., 9001 or 9002) must be open.
- **Installed Components:** A functional installation of Snort (2.x or 3) and a system logger such as `rsyslog` or `syslog-ng` must be present on the sensor.
- **Rule Configuration:** Snort must be configured with a valid ruleset to generate alerts; otherwise, no data will be forwarded to Elastic.
- **Information Requirements:** You will need the IP address of the Elastic Agent and the specific port assigned to the Syslog input during the Kibana setup.

## Elastic prerequisites

- **Elastic Agent:** An active Elastic Agent must be installed and enrolled in Fleet on a host reachable by the Snort server.
- **Integration Installed:** The Snort integration package must be added to an Elastic Agent policy via Kibana.
- **Inbound Connectivity:** The host running the Elastic Agent must allow inbound traffic on the port specified in the integration settings (default is often 9002).

## Vendor set up steps

### For Snort 3 (Lua Configuration):

1.  Log in to the Snort sensor via SSH or terminal.
2.  Navigate to the Snort configuration directory: `cd /usr/local/etc/snort/`.
3.  Open the `snort.lua` configuration file:
    ```bash
    sudo vi snort.lua
    ```
4.  Locate the `outputs` section and configure the `alert_syslog` module. Add the following block to your configuration:
    ```lua
    alert_syslog = 
    {
        facility = 'local7',
        level = 'info',
    }
    ```
5.  Comment out other alert outputs like `alert_fast` or `alert_full` if they are not needed to prevent duplicate local logging.
6.  Save the file and exit the editor.
7.  Verify the Snort configuration syntax:
    ```bash
    snort -c /usr/local/etc/snort/snort.lua -T
    ```
8.  Restart the Snort service to apply changes:
    ```bash
    sudo systemctl restart snort
    ```

### For Syslog Forwarding (rsyslog):

1.  Create a new rsyslog configuration file for Snort:
    ```bash
    sudo vi /etc/rsyslog.d/60-snort.conf
    ```
2.  Add the forwarding rule to send data to the Elastic Agent. Replace `<agent_ip>` with the actual IP of the Elastic Agent:
    ```text
    # Forward Snort local7 logs to Elastic Agent via UDP
    local7.*    @<agent_ip>:514
    ```
    *Note: Use `@@` for TCP if the Elastic Agent is configured for TCP syslog.*
3.  Restart rsyslog to activate the forwarding:
    ```bash
    sudo systemctl restart rsyslog
    ```

## Kibana set up steps

### For Syslog Input:

1.  **Navigate to Integrations:** In Kibana, go to **Management > Integrations**.
2.  **Search for Snort:** Type "Snort" in the search bar and select the Snort integration.
3.  **Add Snort:** Click **Add Snort**.
4.  **Configure Integration Settings:**
    *   Select the **Syslog** data stream.
    *   Set **Syslog Host** to `0.0.0.0` to listen on all interfaces or the specific IP of the Agent host.
    *   Set **Syslog Port** to the value used in your vendor setup (e.g., `9002`).
    *   Select the **Protocol** (TCP or UDP) to match your `rsyslog` configuration.
5.  **Apply Policy:** Choose the existing Agent policy that includes your target Elastic Agent.
6.  **Save and Deploy:** Click **Save and Continue** to deploy the configuration to the Agent.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Snort to the Elastic Stack.

### 1. Trigger Data Flow on Snort:
- **Run Configuration Test:** Execute `snort -c /usr/local/etc/snort/snort.lua -T`. This generates internal configuration logs that may be captured depending on your facility settings.
- **Generate Test Alert:** From a separate machine on the network, perform a simple port scan against the Snort sensor using nmap: `nmap -sS <snort_sensor_ip>`. This should trigger default "GPL SCAN nmap" rules.
- **Restart Service:** Execute `sudo systemctl restart snort`. This will generate system start/stop events in the syslog stream.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the following KQL filter: `data_stream.dataset : "snort.log"`
4. Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `snort.log`)
   - `source.ip` and `destination.ip` (verify these match your test scan)
   - `event.action` or `event.outcome`
   - `snort.alert.msg` or `message` (containing the raw rule description)
5. Navigate to **Analytics > Dashboards** and search for "Snort" to view pre-built visualizations and confirm the map and charts are populating.

# Troubleshooting

## Common Configuration Issues

- **Incorrect Facility Mapping**: If logs are not appearing, ensure that the `facility` defined in `snort.lua` (e.g., `local7`) exactly matches the facility filter in your rsyslog config (`local7.*`). If they differ, logs will be dropped or sent to the wrong destination.
- **Firewall Obstructions**: If the Agent is not receiving data, check the host firewall (iptables/ufw) on both the Snort sensor and the Elastic Agent host. Ensure the configured syslog port (e.g., 514 UDP/TCP) is open for communication.
- **Rsyslog Syntax Errors**: Check for errors in the rsyslog configuration by running `rsyslogd -N1`. A single syntax error in `/etc/rsyslog.d/` files can cause the entire daemon to fail or ignore forwarding rules.
- **Snort Permissions**: Ensure the user running the Snort process has permissions to write to the system's log sockets. This is usually handled by running Snort as a service with appropriate group memberships.

## Ingestion Errors

- **Timestamp Parsing Failures**: If the `event.ingested` field is present but `event.created` is missing, there may be a format mismatch in the syslog header. Ensure Snort is sending logs in a standard format and the Elastic Agent is set to the correct syslog parser (BSD vs RFC 5424).
- **Incomplete Log Lines**: In high-traffic scenarios using UDP, packets may arrive out of order or truncated. If you see `_grokparsefailure` tags in Kibana, consider switching to TCP forwarding to ensure log integrity.
- **Mapping Conflicts**: Check the `error.message` field in Kibana Discover. If you see "mapper_parsing_exception", it indicates a field in the Snort log is conflicting with an existing index template mapping.

## Vendor Resources

- [Snort 3 Configuration Documentation](https://docs.snort.org/start/configuration)
- [Snort 3 Syslog Configuration Example - seclists.org](https://seclists.org/snort/2020/q2/48)
- [Comprehensive Guide to Snort: Logging and Alerting](https://www.ids-sax2.com/comprehensive-guide-to-snort-logging-and-alerting-in-network-intrusion-detection-systems/)

# Documentation sites

- [Snort 3 Configuration Documentation](https://docs.snort.org/start/configuration)
- [Comprehensive Guide to Snort: Logging and Alerting](https://www.ids-sax2.com/comprehensive-guide-to-snort-logging-and-alerting-in-network-intrusion-detection-systems/)
- Refer to the official vendor website for additional resources.
