# Service Info

## Common use cases

The Citrix ADC (formerly NetScaler) integration provides comprehensive visibility into application delivery, load balancing, and network security events. This integration enables security and operations teams to monitor the health and performance of their ADC appliances.
- **Security and Compliance Auditing:** Monitor administrative logins, configuration changes (commands executed via CLI or GUI), and policy modifications to ensure regulatory compliance and detect unauthorized access.
- **Traffic and Load Balancing Analysis:** Track how traffic is distributed across backend services, identify server failures, and monitor application availability in real-time.
- **System Health and Performance Monitoring:** Capture hardware-related events, interface status changes, and system-level errors to proactively address potential downtime.
- **Troubleshooting Application Delivery:** Analyze SSL/TLS handshake failures, content switching decisions, and rewrite/responder policy triggers to resolve end-user connectivity issues.

## Data types collected

This integration can collect the following types of data:
- **Audit Logs:** Comprehensive logs of all administrative commands executed via the CLI, GUI, or API, typically sent via Syslog.
- **System Events:** General system-level events including hardware health, service state changes (UP/DOWN), and high availability (HA) transitions.
- **Authentication Logs (AAA):** Details regarding user sessions, authentication methods used, and authorization outcomes for Gateway or management access.
- **Web App Firewall (WAF) Logs:** Security-specific logs containing information about policy violations, signature matches, and blocked requests, ideally formatted in CEF.
- **Data Formats:** Supports standard Syslog format (RFC 3164/5424) and Common Event Format (CEF) for security-specific data streams.

## Compatibility

The **Citrix ADC** integration is compatible with Citrix ADC (NetScaler) versions 12.x, 13.x, and 14.x. It supports both standalone and High Availability (HA) configurations, processing standard syslog output generated by the management IP (NSIP) or subnet IP (SNIP).

## Scaling and Performance

- **Transport/Collection Considerations:** When configuring the syslog action on the Citrix ADC, users must choose between TCP and UDP. TCP is recommended for environments requiring guaranteed log delivery for audit compliance, whereas UDP is preferred for high-volume traffic monitoring to minimize the performance impact on the ADC appliance's CPU.
- **Data Volume Management:** To prevent overwhelming the Elastic Stack, use the Citrix ADC "Log Levels" settings to filter events at the source. For production environments, consider limiting logs to `CRITICAL`, `ERROR`, and `WARNING` levels, or use specific policy expressions to exclude high-volume, low-value events like session heartbeats.
- **Elastic Agent Scaling:** For large-scale deployments with multiple ADC appliances, deploy the Elastic Agent on a dedicated host or use multiple Agents behind a load balancer. A single Elastic Agent can typically handle thousands of events per second, but resource allocation should be scaled (vCPU and RAM) based on the total aggregate throughput of all connected ADC devices.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Superuser credentials are required to access the Citrix ADC management GUI or CLI for configuring auditing settings.
- **Network Connectivity:** The Citrix ADC appliance must have a clear network path to the Elastic Agent host. Ensure that port 514 (or your custom syslog port) is open on any intermediate firewalls.
- **IP Information:** Knowledge of the Elastic Agent's IP address and the Citrix ADC's Management IP (NSIP) or Subnet IP (SNIP) used for log forwarding.
- **License Requirements:** Auditing and syslog forwarding features must be enabled (typically available in Standard, Enterprise, and Platinum editions).

## Elastic prerequisites

- **Elastic Agent:** An Elastic Agent must be installed and successfully enrolled in a policy via Fleet.
- **Integration Package:** The `citrix_adc` integration must be added to the Agent policy in Kibana.
- **Network Listener:** The Elastic Agent must be configured with a syslog input listening on a specific port and protocol that matches the ADC configuration.

## Vendor set up steps

### For Syslog Collection (GUI Method):

1. Log in to the Citrix ADC management interface (GUI).
2. Navigate to **Configuration > System > Auditing > Syslog**.
3. In the main pane, click the **Servers** tab and then click **Add**.
4. Configure the **Syslog Action**:
    - **Name**: Enter a descriptive name (e.g., `elastic-agent-action`).
    - **IP Address**: Enter the IP address of your Elastic Agent.
    - **Port**: Enter the port configured in your Elastic Agent policy (e.g., `9002`).
    - **Transport**: Select **TCP** or **UDP**.
    - **Log Levels**: Check all levels from **EMERGENCY** to **INFORMATIONAL**.
5. Navigate to the **Policies** tab and click **Add**.
6. Configure the **Syslog Policy**:
    - **Name**: Enter a name (e.g., `elastic-agent-policy`).
    - **Action**: Select the action created in step 4.
    - **Expression**: Enter `TRUE` to capture all audit logs.
7. Activate the policy by clicking the **Action** drop-down on the top right and selecting **Advanced Policy Global Bindings**.
8. Click **Add Binding**, select your policy, set the **Priority** to `100`, and set the **Bind Point** to `SYSTEM_GLOBAL`.
9. Click **Bind** and then **Done**.

### For Syslog Collection (CLI Method):

1. Establish an SSH session to the Citrix ADC management IP.
2. Create the syslog action by running:
   ```shell
   add audit syslogAction elastic-agent-syslog-action <AGENT_IP> -serverPort 9002 -transport TCP -logLevel EMERGENCY ALERT CRITICAL ERROR WARNING NOTICE INFORMATIONAL
   ```
3. Create the syslog policy to match all traffic:
   ```shell
   add audit syslogPolicy elastic-agent-syslog-policy TRUE elastic-agent-syslog-action
   ```
4. Bind the policy globally to start the data flow:
   ```shell
   bind audit syslogGlobal -policyName elastic-agent-syslog-policy -priority 100 -globalBindType SYSTEM_GLOBAL
   ```

### For Web App Firewall (CEF) Logging:

1. In the Citrix ADC GUI, navigate to **Security > Citrix Web App Firewall**.
2. In the **Settings** section, click **Change Engine Settings**.
3. Enable the checkbox for **CEF Logging**. This ensures that security events are sent in a structured format that Elastic can parse more effectively.
4. Click **OK** to save the changes.

## Kibana set up steps

1. **Navigate to the Integration:** In Kibana, go to **Management > Integrations**. Search for **Citrix ADC** and select it.
2. **Add the Integration:** Click **Add Citrix ADC**.
3. **Configure the Integration Name:** Provide a name for this integration instance (e.g., `citrix-adc-prod`).
4. **Configure Syslog Settings:**
   - Under the **Syslog** section, ensure the toggle is enabled.
   - **Syslog Host**: Set to `0.0.0.0` to listen on all interfaces or the specific IP of the host machine.
   - **Syslog Port**: Enter the port matching your Citrix ADC configuration (e.g., `514`).
   - **Protocol**: Select the protocol matching your Citrix ADC configuration (e.g., `tcp` or `udp`).
5. **Advanced Settings:** Expand **Advanced options** if you need to modify internal timeouts or specific tags for this data stream.
6. **Save and Deploy:** Click **Save and continue**, then select the appropriate **Agent Policy** to deploy the configuration to your Elastic Agent.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Citrix ADC to the Elastic Stack.

### 1. Trigger Data Flow on Citrix ADC:
- **Generate authentication event:** Log out of the Citrix ADC management GUI and log back in to trigger an authentication audit log.
- **Generate configuration event:** Open the CLI (via SSH) and enter configuration mode by typing `config t`, then immediately type `exit` to generate a session end event.
- **Generate system event:** Navigate to any load balancing virtual server and briefly toggle its state (Disable then Enable) to trigger a state-change event.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the following KQL filter: `data_stream.dataset : "citrix_adc.log"`
4. Verify logs appear in the results. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `citrix_adc.log`)
   - `source.ip` (the IP of the Citrix ADC appliance)
   - `event.action` (e.g., `login`, `logout`, or `cmd_execution`)
   - `citrix_adc.log.mnemonic` (e.g., `GUI_LOGIN` or `CLI_CMD_EXECUTED`)
   - `message` (containing the raw syslog payload from the NetScaler)
5. Navigate to **Analytics > Dashboards** and search for "Citrix ADC" to view the pre-built Overview and Audit dashboards.

# Troubleshooting

## Common Configuration Issues

- **Policy Not Bound Globally**: If logs are not appearing, verify that the Syslog Policy is bound to the `SYSTEM_GLOBAL` bind point. Without this binding, the policy exists but does not actively process any events.
- **Incorrect Syslog Expression**: If only specific logs are missing, check the policy expression. An expression of `TRUE` ensures all logs are sent, while more complex expressions might be filtering out the data you expect to see.
- **Port Conflict**: Ensure that the port assigned to the Elastic Agent (e.g., 9002) is not being used by another service on the host machine. You can verify this using `netstat -tulpn | grep 9002` on Linux hosts.
- **Firewall Blocking**: Verify that any network firewalls or local host firewalls (like `iptables` or `firewalld`) allow inbound traffic from the Citrix ADC IP to the Agent IP on the configured syslog port.

## Ingestion Errors

- **Parsing Failures**: If logs appear in Kibana but contain a `tags: ["_grokparsefailure"]` or similar error, ensure the Citrix ADC is not using a custom log format that deviates from standard syslog expectations. Enabling CEF logging for WAF is specifically required for security logs to parse correctly.
- **Timestamp Mismatch**: If logs are not appearing in the current time window, check for clock skew between the Citrix ADC appliance and the Elastic Agent host. It is highly recommended to use NTP on both systems.
- **Incomplete Log Lines**: For very large log messages (often seen in WAF logs), UDP may truncate the packet. Switch to TCP transport to ensure large messages are delivered intact.

## Vendor Resources

- [How to enable Syslog over TCP in ADC - Citrix Customer Support](https://support.citrix.com/external/article/CTX205824/how-to-enable-syslog-over-tcp-in-adc.html)
- [Citrix ADC syslog configuration – The missing pieces - Citrix Blogs](https://www.citrix.com/blogs/2020/08/25/citrix-adc-syslog-configuration-the-missing-pieces/)

## Documentation sites

- [Configure Citrix NetScaler to send logs to Arctic Wolf](https://docs.arcticwolf.com/bundle/m_syslog/page/configure_citrix_netscaler_to_send_logs_to_arctic_wolf.html)
- [How to Generate Custom Log Message on ADC for SYSLOG](https://support.citrix.com/external/article/CTX694672/how-to-generate-custom-log-message-on-ad.html)
- [Configuring syslog on instances | NetScaler® Console service](https://docs.netscaler.com/en-us/netscaler-console-service/setting-up/configuring-syslog-on-instances.html)
